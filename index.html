<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>TOTP验证工具</title>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 20px auto; padding: 20px; }
        .item { margin: 15px 0; padding: 10px; border: 1px solid #eee; border-radius: 8px; }
        .code { font-size: 2em; font-weight: bold; color: #5865F2; }
        input { width: 100%; padding: 10px; font-size: 1.2em; margin: 10px 0; }
        button { padding: 10px 20px; background: #5865F2; color: white; border: none; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>TOTP验证码验证工具</h1>
    <input type="text" id="secret" placeholder="输入你的密钥（如FXVLGSEADALXX6BBY3NT3FUU2BUVV7QA）" value="FXVLGSEADALXX6BBY3NT3FUU2BUVV7QA">
    <button onclick="checkCode()">生成验证</button>
    
    <div class="item">
        <div>当前UTC时间戳：<span id="utcTime"></span></div>
        <div>当前本地时间：<span id="localTime"></span></div>
    </div>
    
    <div class="item">
        <div>当前步长验证码（正确）：<span class="code" id="currentCode"></span></div>
        <div>上一步长验证码（时间慢30秒）：<span class="code" id="prevCode"></span></div>
        <div>下一步长验证码（时间快30秒）：<span class="code" id="nextCode"></span></div>
    </div>

    <script>
        // 标准Base32解码
        function base32Decode(encoded) {
            const base32Chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            encoded = encoded.toUpperCase().replace(/[^A-Z2-7]/g, '');
            const bits = [];
            for (let i = 0; i < encoded.length; i++) {
                const idx = base32Chars.indexOf(encoded[i]);
                if (idx === -1) continue;
                bits.push(idx.toString(2).padStart(5, '0'));
            }
            const bitString = bits.join('');
            const bytes = [];
            for (let i = 0; i < bitString.length; i += 8) {
                const byte = bitString.slice(i, i + 8);
                if (byte.length === 8) bytes.push(parseInt(byte, 2));
            }
            return new Uint8Array(bytes);
        }

        // 纯JS HMAC-SHA1
        function hmacSHA1(key, data) {
            function sha1(data) {
                function rotateLeft(n, s) { return (n << s) | (n >>> (32 - s)); }
                function toHex(n) { let hex = n.toString(16); return hex.length % 2 ? '0' + hex : hex; }
                data = new Uint8Array(data);
                const len = data.length * 8;
                data = [...data, 0x80];
                while (data.length % 64 !== 56) data.push(0);
                data = new Uint8Array([...data, ...new Uint8Array(8).map((_, i) => (len >>> (8 * (7 - i))) & 0xff)]);
                let h0 = 0x67452301, h1 = 0xEFCDAB89, h2 = 0x98BADCFE, h3 = 0x10325476, h4 = 0xC3D2E1F0;
                for (let i = 0; i < data.length; i += 64) {
                    const w = new Uint32Array(80);
                    for (let j = 0; j < 16; j++) w[j] = (data[i + j * 4] << 24) | (data[i + j * 4 + 1] << 16) | (data[i + j * 4 + 2] << 8) | data[i + j * 4 + 3];
                    for (let j = 16; j < 80; j++) w[j] = rotateLeft(w[j - 3] ^ w[j - 8] ^ w[j - 14] ^ w[j - 16], 1);
                    let a = h0, b = h1, c = h2, d = h3, e = h4;
                    for (let j = 0; j < 80; j++) {
                        let f, k;
                        if (j < 20) { f = (b & c) | (~b & d); k = 0x5A827999; }
                        else if (j < 40) { f = b ^ c ^ d; k = 0x6ED9EBA1; }
                        else if (j < 60) { f = (b & c) | (b & d) | (c & d); k = 0x8F1BBCDC; }
                        else { f = b ^ c ^ d; k = 0xCA62C1D6; }
                        const temp = rotateLeft(a, 5) + f + e + k + w[j] >>> 0;
                        e = d; d = c; c = rotateLeft(b, 30) >>> 0; b = a; a = temp;
                    }
                    h0 = (h0 + a) >>> 0; h1 = (h1 + b) >>> 0; h2 = (h2 + c) >>> 0; h3 = (h3 + d) >>> 0; h4 = (h4 + e) >>> 0;
                }
                return [h0, h1, h2, h3, h4].map(toHex).join('');
            }
            key = new Uint8Array(key);
            if (key.length > 64) key = new Uint8Array(sha1(key).match(/.{2}/g).map(h => parseInt(h, 16)));
            while (key.length < 64) key = new Uint8Array([...key, 0]);
            const ipad = new Uint8Array(64).fill(0x36);
            const opad = new Uint8Array(64).fill(0x5C);
            const ikey = new Uint8Array(64).map((_, i) => key[i] ^ ipad[i]);
            const okey = new Uint8Array(64).map((_, i) => key[i] ^ opad[i]);
            const inner = new Uint8Array([...ikey, ...data]);
            const innerHash = new Uint8Array(sha1(inner).match(/.{2}/g).map(h => parseInt(h, 16)));
            const outer = new Uint8Array([...okey, ...innerHash]);
            return new Uint8Array(sha1(outer).match(/.{2}/g).map(h => parseInt(h, 16)));
        }

        // 生成指定时间步长的验证码
        function generateTOTP(secret, timeStepOffset = 0) {
            const secretBytes = base32Decode(secret);
            const time = Math.floor(Date.now() / 1000 / 30) + timeStepOffset;
            const timeBuffer = new ArrayBuffer(8);
            new DataView(timeBuffer).setBigInt64(0, BigInt(time), false);
            const timeBytes = new Uint8Array(timeBuffer);
            const hmacResult = hmacSHA1(secretBytes, timeBytes);
            const offset = hmacResult[hmacResult.length - 1] & 0x0F;
            const code = (
                ((hmacResult[offset] & 0x7F) << 24) |
                ((hmacResult[offset + 1] & 0xFF) << 16) |
                ((hmacResult[offset + 2] & 0xFF) << 8) |
                (hmacResult[offset + 3] & 0xFF)
            ) % 1000000;
            return code.toString().padStart(6, '0');
        }

        // 验证主函数
        function checkCode() {
            const secret = document.getElementById('secret').value.trim();
            // 显示时间信息
            document.getElementById('utcTime').textContent = Math.floor(Date.now() / 1000) + ' (UTC秒级)';
            document.getElementById('localTime').textContent = new Date().toString();
            // 生成当前/上一个/下一个步长的验证码
            document.getElementById('currentCode').textContent = generateTOTP(secret, 0);
            document.getElementById('prevCode').textContent = generateTOTP(secret, -1);
            document.getElementById('nextCode').textContent = generateTOTP(secret, 1);
        }

        // 初始化
        window.onload = checkCode;
    </script>
</body>
</html>
