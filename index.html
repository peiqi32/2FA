<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Discord专用2FA验证码生成器</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            max-width: 900px; 
            margin: 30px auto; 
            padding: 20px; 
            text-align: center;
        }
        h1 { color: #5865F2; margin: 20px 0; font-size: 2.2em; }
        .secret-input {
            width: 100%;
            padding: 15px;
            font-size: 1.5em;
            border: 2px solid #eee;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            resize: none;
            min-height: 100px;
        }
        .secret-input:focus {
            border-color: #5865F2;
            outline: none;
            box-shadow: 0 0 8px rgba(88, 101, 242, 0.2);
        }
        .code-container {
            margin: 30px 0;
        }
        .main-code {
            font-size: 6em;
            font-weight: bold;
            color: #5865F2;
            letter-spacing: 8px;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 15px;
            cursor: pointer;
        }
        .main-code.copied {
            color: #27ae60;
            background: #eafaf1;
        }
        .countdown {
            font-size: 1.8em;
            color: #666;
            margin: 10px 0;
        }
        .btn-group {
            margin: 20px 0;
        }
        button {
            padding: 12px 25px;
            margin: 0 10px;
            font-size: 1.2em;
            border: none;
            border-radius: 8px;
            background: #5865F2;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        button:hover {
            background: #4752C4;
        }
        .tip {
            color: #999;
            font-size: 1.1em;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Discord专用2FA验证码生成器</h1>
    
    <textarea class="secret-input" id="secretInput" placeholder="粘贴Discord的2FA密钥（二维码提取的secret）">FXVLGSEADALXX6BBY3NT3FUU2BUVV7QA</textarea>
    
    <div class="btn-group">
        <button onclick="updateCode()">刷新验证码</button>
        <button onclick="resetSecret()">重置密钥</button>
    </div>

    <div class="code-container">
        <div class="main-code" id="mainCode" onclick="copyCode()">点击复制验证码</div>
    </div>

    <div class="countdown" id="countdown">剩余有效时间：--秒</div>
    <div class="tip">提示：Discord 2FA使用SHA256算法，此工具已适配</div>

    <script>
        // Discord 2FA专用配置
        const INTERVAL = 30;
        let currentSecret = document.getElementById('secretInput').value.trim();

        // Discord兼容的Base32解码（处理其特殊填充）
        function base32Decode(secret) {
            const ALPHABET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            secret = secret.toUpperCase().replace(/[^A-Z2-7]/g, '');
            if (secret.length === 0) return new Uint8Array(0);

            // Discord密钥可能缺少填充符，补全到8的倍数
            while (secret.length % 8 !== 0) secret += '=';

            let bits = '';
            for (let c of secret) {
                if (c === '=') break;
                const idx = ALPHABET.indexOf(c);
                if (idx === -1) continue;
                bits += idx.toString(2).padStart(5, '0');
            }

            const bytes = [];
            for (let i = 0; i < bits.length; i += 8) {
                const byte = bits.slice(i, i + 8);
                if (byte.length === 8) bytes.push(parseInt(byte, 2));
            }
            return new Uint8Array(bytes);
        }

        // Discord 2FA专用：HMAC-SHA256（而非SHA1）
        async function hmacSHA256(keyBytes, dataBytes) {
            const cryptoKey = await crypto.subtle.importKey(
                'raw', keyBytes, { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']
            );
            const signature = await crypto.subtle.sign('HMAC', cryptoKey, dataBytes);
            return new Uint8Array(signature);
        }

        // 生成Discord专用2FA验证码
        async function generateDiscordCode() {
            if (!currentSecret) return '无密钥';
            const secretBytes = base32Decode(currentSecret);
            if (secretBytes.length === 0) return '密钥错误';

            // Discord使用标准30秒时间步长
            const time = Math.floor(Date.now() / 1000 / INTERVAL);
            const timeBuffer = new ArrayBuffer(8);
            new DataView(timeBuffer).setBigInt64(0, BigInt(time), false); // 大端序
            const timeBytes = new Uint8Array(timeBuffer);

            // 核心差异：Discord用SHA256而非SHA1
            const hmac = await hmacSHA256(secretBytes, timeBytes);
            const offset = hmac[hmac.length - 1] & 0x0F;
            
            // 截断计算（和标准TOTP一致，但基于SHA256结果）
            const code = (
                ((hmac[offset] & 0x7F) << 24) |
                ((hmac[offset + 1] & 0xFF) << 16) |
                ((hmac[offset + 2] & 0xFF) << 8) |
                (hmac[offset + 3] & 0xFF)
            ) % 1000000;

            return code.toString().padStart(6, '0');
        }

        // 更新验证码和倒计时
        async function updateCode() {
            currentSecret = document.getElementById('secretInput').value.trim();
            
            const code = await generateDiscordCode();
            document.getElementById('mainCode').textContent = code;
            
            // 更新倒计时
            const remaining = INTERVAL - (Math.floor(Date.now() / 1000) % INTERVAL);
            document.getElementById('countdown').textContent = `剩余有效时间：${remaining}秒`;
        }

        // 复制验证码
        function copyCode() {
            const code = document.getElementById('mainCode').textContent;
            if (code.length !== 6) return;
            
            navigator.clipboard.writeText(code).then(() => {
                const el = document.getElementById('mainCode');
                el.classList.add('copied');
                el.textContent = '✅ ' + code;
                setTimeout(() => {
                    el.classList.remove('copied');
                    el.textContent = code;
                }, 1500);
            });
        }

        // 重置密钥
        function resetSecret() {
            currentSecret = document.getElementById('secretInput').placeholder;
            document.getElementById('secretInput').value = currentSecret;
            updateCode();
        }

        // 初始化+自动刷新
        window.onload = async () => {
            await updateCode();
            setInterval(updateCode, 1000);
            
            // 回车刷新
            document.getElementById('secretInput').addEventListener('keypress', async (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    await updateCode();
                }
            });
        };
    </script>
</body>
</html>
